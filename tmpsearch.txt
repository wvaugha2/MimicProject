WITH patients AS(                                                                       
    SELECT                                                                              
    i.subject_id, i.icustay_id, i.hadm_id, i.los,                                      
    i.first_careunit, i.intime, p.dob, p.gender,                                        
    row_number() OVER (partition BY i.subject_id ORDER BY i.intime desc) AS lasttime,
    
    (   SELECT COALESCE( (SELECT 
        CASE 
            WHEN c.itemid IN (3581)
            THEN c.valuenum * 0.45359
            WHEN c.itemid IN (3582)
            THEN c.valuenum * 0.028349
            ELSE c.valuenum
        END AS value
        FROM mimiciii.chartevents c
        WHERE c.subject_id = i.subject_id 
        AND c.hadm_id = i.hadm_id
        AND c.charttime <= i.intime
        AND c.valuenum IS NOT NULL
        AND c.itemid IN (762, 763, 3723, 3580, 
                        3581, 3582)
        ORDER BY c.charttime
        LIMIT 1), -1)) AS weight,

    (   SELECT COALESCE( (SELECT 
        CASE 
            WHEN c.itemid IN (920, 1394, 4187, 3486, 226707)
            THEN c.valuenum * 2.54
            ELSE c.valuenum
        END AS value
        FROM mimiciii.chartevents c
        WHERE c.subject_id = i.subject_id 
        AND c.hadm_id = i.hadm_id
        AND c.charttime <= i.intime
        AND c.valuenum IS NOT NULL
        AND c.itemid IN (920, 1394, 4187, 3486,
                        3485, 4188, 226707)
        ORDER BY c.charttime
        LIMIT 1), -1)) AS height

    FROM mimiciii.icustays i                                                            
    INNER JOIN mimiciii.patients p ON p.subject_id = i.subject_id
    LIMIT 100                       
)
SELECT *                                                                                
FROM patients p                                                                      
WHERE p.los >= 2                                                                       
AND p.lasttime = 1                                                                      
AND p.intime > p.dob+interval '16' year                                                 
AND p.gender IN ('M','F')                                                                                                                                
ORDER BY subject_id
LIMIT 10;


    # Create the query to obtain patients
    patientquery = "WITH patients AS(                                                                       \
                        SELECT                                                                              \
                        i.subject_id, i.icustay_id, i.hadm_id, i.los,                                       \
                        i.first_careunit, i.intime, p.dob, p.gender,                                        \
                        row_number() OVER (partition BY i.subject_id ORDER BY i.intime desc) AS lasttime,   \
                                                                                                            \
                        -- Obtain the weight of the patient recorded closest to ICU admission               \
                        (   SELECT COALESCE( (SELECT                                                        \
                            CASE                                                                            \
                                WHEN c.itemid IN (3581)                                                     \
                                THEN c.valuenum * 0.45359                                                   \
                                WHEN c.itemid IN (3582)                                                     \
                                THEN c.valuenum * 0.028349                                                  \
                                ELSE c.valuenum                                                             \
                            END AS value                                                                    \
                            FROM mimiciii.chartevents c                                                     \
                            WHERE c.subject_id = i.subject_id                                               \
                            AND c.hadm_id = i.hadm_id                                                       \
                            AND c.charttime <= i.intime                                                     \
                            AND c.valuenum IS NOT NULL                                                      \
                            AND c.itemid IN (762, 763, 3723, 3580,                                          \
                                            3581, 3582)                                                     \
                            ORDER BY c.charttime DESC                                                       \
                            LIMIT 1), -1)) AS weight,                                                       \
                                                                                                            \
                        -- Obtain the height of the patient recorded closest to ICU admission               \
                        (   SELECT COALESCE( (SELECT                                                        \
                            CASE                                                                            \
                                WHEN c.itemid IN (920, 1394, 4187, 3486, 226707)                            \
                                THEN c.valuenum * 2.54                                                      \
                                ELSE c.valuenum                                                             \
                            END AS value                                                                    \
                            FROM mimiciii.chartevents c                                                     \
                            WHERE c.subject_id = i.subject_id                                               \
                            AND c.hadm_id = i.hadm_id                                                       \
                            AND c.charttime <= i.intime                                                     \
                            AND c.valuenum IS NOT NULL                                                      \
                            AND c.itemid IN (920, 1394, 4187, 3486,                                         \
                                            3485, 4188, 226707)                                             \
                            ORDER BY c.charttime                                                            \
                            LIMIT 1), -1)) AS height                                                        \
                                                                                                            \
                        FROM mimiciii.icustays i                                                            \
                        INNER JOIN mimiciii.patients p ON p.subject_id = i.subject_id                       \
                        LIMIT 100                                                                           \
                    )                                                                                       \
                    SELECT *                                                                                \
                    FROM patients p                                                                         \
                    WHERE p.los >= {}                                                                       \
                    AND p.lasttime = 1                                                                      \
                    AND p.intime > p.dob+interval '{}' year                                                 \
                    AND p.intime < p.dob+interval '{}' year                                                 \
                    AND p.gender IN ({})                                                                    \
                    AND p.first_careunit IN ({})                                                            \
                    ORDER BY p.subject_id;".format(
                        PatientInfo['Hours'] / 24, 
                        PatientInfo['Age']['min'], PatientInfo['Age']['max'],
                        "\'M\',\'F\'" if PatientInfo['Sex'] == 'Both' else "\'"+PatientInfo['Sex']+"\'",
                        icutypes,
                        )
